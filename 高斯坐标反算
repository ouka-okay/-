clc
clear
%高斯坐标反算（参考椭球的长半径和扁率和对应椭球下的坐标都要输入）
%手动输入高斯坐标y，前面两位是带号，第三位是加500km得到结果，y=Y-N-500km。Y是输入坐标，N表示几度带。
X = 2463376.6502;
Y = 19549592.0721;
%手动输入参考椭球的长半径和扁率
a = 6378137;%长半径
b = a *(1- 1/298.257223563);%计算参考椭球是WGS84，GDJ80,BJ54
%手动输入按几度带计算
JJD = 6;
%--------------------------------------------------------------------------
%计算Y,得到它位于几度带，以求中央子母线
N = Y/1000000-1;
N = roundn(N,0);%表示位于几度带
%--------------------------------------------------------------------------
%手动输入计算Y后的高斯坐标的x和y在下面(也可以让电脑自己计算不用管这里)
x = X;
%y = 49592.0721;
y=(Y/1000000-N)*1000000-500000 ;
%--------------------------------------------------------------------------
%计算B_f(迭代计算)
c =a^2/b;
e1 = ((a^2-b^2)^(1/2))/a;%第一偏心率
e2 = ((a^2-b^2)^(1/2))/b;%第二偏心率
%--------------------------------------------------------------------------
%下面都是迭代的形式，但是以两种不同的理解去计算B_f(结果都吻合)
%--------------------------------------------------------------------------
%m0 = a*(1-e1^2); m2 = (3*e1^2*m0)/2; m4 = (5*e1^2*m2)/4; m6 = (7*e1^2*m4)/6; m8 = (9*e1^2*m6)/8; 
%a0 = m0+m2/2+3*m4/8+5*m6/16+35*m8/128; a2 = m2/2+m4/2+15*m6/32+7*m8/16;
%a4 = m4/8+3*m6/16+7*m8/32; a6 = m6/32+m8/16; a8 = m8/128;%%按课本P115（4-100）计算各常量
%--------------------------------------------------------------------------
beta_0=1-3/4*e2^2+45/64*e2^4-175/256*e2^6+11025/16384*e2^8;%按课本P116（4-108）计算各常量
beta_2=beta_0-1;
beta_4=15/32*e2^4-175/384*e2^6+3675/8192*e2^8;
beta_6=-35/96*e2^6+735/2048*e2^8;
beta_8=315/1024*e2^8;
%--------------------------------------------------------------------------
%下面按课本P118（4-122）-（4-123）采用迭代法计算底点纬度
%--------------------------------------------------------------------------
B_f=x/beta_0/c;
%B_f=x/a0;%两种理解分别计算B_f（可以转换）
%--------------------------------------------------------------------------
cos_B=cos(B_f);
sin_B=sin(B_f);
%--------------------------------------------------------------------------
%F_B_f=-a2*sin(2*B_f)/2+a4*sin(4*B_f)/4-a6*sin(6*B_f)/6+a8*sin(8*B_f)/8;
%B_f_2=(x-F_B_f)/a0;%两种理解分别计算F_B_f和B_f_2（可以转换）
F_B_f=(beta_2.*cos_B+beta_4.*cos_B.^3+beta_6.*cos_B.^5+beta_8.*cos_B.^7).*sin_B.*c;
B_f_2=(x-F_B_f)/beta_0/c;
%--------------------------------------------------------------------------
sigma=B_f_2-B_f;%设定迭代的初值
while (sigma/acos(-1)*180*60*60)>=0.00001%利用while循环，设置阈值为0.00001″，当B_f前后两次之差小于阈值时完成迭代
B_f=B_f_2;
cos_B=cos(B_f);
sin_B=sin(B_f);
%F_B_f=-a2*sin(2*B_f)/2+a4*sin(4*B_f)/4-a6*sin(6*B_f)/6+a8*sin(8*B_f)/8;
%B_f_2=(x-F_B_f)/a0;
F_B_f=(beta_2.*cos_B+beta_4.*cos_B.^3+beta_6.*cos_B.^5+beta_8.*cos_B.^7).*sin_B.*c;
B_f_2=(x-F_B_f)/beta_0/c;
sigma=B_f_2-B_f;
end
%--------------------------------------------------------------------------
W = sqrt(1-e1^2*sin(B_f)^2);
N_f = a/W;
t_f = tan(B_f);
H_f = e2*cos(B_f);
M_f = a*(1-e1^2)*(1-e1^2*sin(B_f)^2)^(-1.5);

B = B_f - (t_f*y^2)/(2*M_f*N_f) + (t_f*(5+3*t_f^2+H_f^2-9*H_f^2*t_f^2)*y^4)/(24*M_f*N_f^3) - (t_f*(61+90*t_f^2+45*t_f^4)*y^6)/(720*M_f*N_f^5);%计算B
l = y/(N_f*cos(B_f))-(1+2*t_f^2+H_f^2)*y^3/(6*N_f^3*cos(B_f))+(5+28*t_f^2+24*t_f^2+6*H_f^2+8*H_f^2*t_f^2)*y^5/(120*N_f^5*cos(B_f));%计算经差l
%-------------------------------------------------------------------------
B_data = rad2deg(B);%把弧度制的B转为以度为单位的小数的数学形式，用与下面的转换
B1=degrees2dms(B_data);%将以度为单位的小数转发为角度
l_data = rad2deg(l);%同上
l1=degrees2dms(l_data);
%--------------------------------------------------------------------------
L_0=JJD*N-3;%计算中央子母线
l1(1,1)=l1(1,1)+L_0;
B1=vpa(B1(1,1),B1(1,2),B1(1,3),7,7,8);%控制纬度的秒小数点后几位的精度（最终结果）
l1=vpa(l1(1,1),l1(1,2),l1(1,3),7,7,8);%控制经差秒的小数点后几位的精度（最终结果还要加上中央经线的度数）%可以计算
%--------------------------------------------------------------------------
%最后计算得到大地坐标结果为B1和l1；




